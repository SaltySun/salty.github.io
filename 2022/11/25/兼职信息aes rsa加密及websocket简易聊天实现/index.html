<!DOCTYPE html><html lang="zh-cn" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>兼职信息aes rsa加密及websocket简易聊天实现 | Dr.SlatySun</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - 共 $1 行","copy":"复制","copyFinish":"复制成功","expand":"展开"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="referrer" content="no-referrer"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Dr.SlatySun" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>兼职信息aes rsa加密及websocket简易聊天实现</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2022-11-24T16:00:00.000Z" id="date"> 2022-11-25</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-03-24T06:51:24.512Z" id="updated"> 2023-03-24</time></div></span></div></div><hr><div id="post-content"><h3 id="AES加密解密"><a href="#AES加密解密" class="headerlink" title="AES加密解密"></a>AES加密解密</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/png/29366328/1667463614204-863fd438-7fc3-4eff-b130-8a1673212002.png#clientId=u734cbe78-c3bb-4&from=paste&height=473&id=u9c42a5af&name=image.png&originHeight=473&originWidth=985&originalType=binary&ratio=1&rotation=0&showTitle=false&size=107753&status=done&style=none&taskId=u350cec6f-4f27-4e00-9e62-9063d636e76&title=&width=985" alt="image.png"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">CryptoJS</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto-js&#x27;</span>)<br><span class="hljs-comment">// const keyStr = &#x27;encode@3#!8^k.j$&#x27;</span><br><span class="hljs-comment">// const ivStr = &#x27;vector@3#!8^k.j$&#x27;</span><br><span class="hljs-comment">// const txt = &#x27;123&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">data, keyS, ivS</span>) &#123;<br>  <span class="hljs-comment">// let key = keyS || keyStr</span><br>  <span class="hljs-comment">// let iv = ivS || ivStr</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data,<span class="hljs-string">&quot;data&quot;</span>);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(keyS,<span class="hljs-string">&quot;keyS&quot;</span>);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ivS,<span class="hljs-string">&quot;ivS&quot;</span>);<br> <span class="hljs-keyword">var</span> key = <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">enc</span>.<span class="hljs-property">Utf8</span>.<span class="hljs-title function_">parse</span>(keyS)<br> <span class="hljs-keyword">var</span> iv = <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">enc</span>.<span class="hljs-property">Utf8</span>.<span class="hljs-title function_">parse</span>(ivS)<br>  <span class="hljs-keyword">const</span> src = <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">enc</span>.<span class="hljs-property">Utf8</span>.<span class="hljs-title function_">parse</span>(data)<br>  <span class="hljs-keyword">const</span> cipher = <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">AES</span>.<span class="hljs-title function_">encrypt</span>(src, key, &#123;<br>    <span class="hljs-attr">iv</span>: iv, <span class="hljs-comment">// 初始向量</span><br>    <span class="hljs-attr">mode</span>: <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">mode</span>.<span class="hljs-property">CBC</span>, <span class="hljs-comment">// 加密模式</span><br>    <span class="hljs-attr">padding</span>: <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">pad</span>.<span class="hljs-property">Pkcs7</span>, <span class="hljs-comment">// 填充方式</span><br>  &#125;)<br>  <span class="hljs-keyword">const</span> encrypted = cipher.<span class="hljs-title function_">toString</span>()<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(encrypted,<span class="hljs-string">&#x27;encrypted&#x27;</span>);<br>  <span class="hljs-keyword">return</span> encrypted<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">data, keyS, ivS</span>) &#123;<br>  <span class="hljs-comment">// let key = keyS || keyStr</span><br>  <span class="hljs-comment">// let iv = ivS || ivStr</span><br> <span class="hljs-keyword">var</span> key = <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">enc</span>.<span class="hljs-property">Utf8</span>.<span class="hljs-title function_">parse</span>(keyS)<br> <span class="hljs-keyword">var</span> iv = <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">enc</span>.<span class="hljs-property">Utf8</span>.<span class="hljs-title function_">parse</span>(ivS)<br>  <span class="hljs-keyword">const</span> cipher = <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">AES</span>.<span class="hljs-title function_">decrypt</span>(data, key, &#123;<br>    <span class="hljs-attr">iv</span>: iv,<br>    <span class="hljs-attr">mode</span>: <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">mode</span>.<span class="hljs-property">CBC</span>,<br>    <span class="hljs-attr">padding</span>: <span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">pad</span>.<span class="hljs-property">Pkcs7</span>,<br>  &#125;)<br>  <span class="hljs-keyword">const</span> decrypted = cipher.<span class="hljs-title function_">toString</span>(<span class="hljs-title class_">CryptoJS</span>.<span class="hljs-property">enc</span>.<span class="hljs-property">Utf8</span>) <span class="hljs-comment">// 返回的是加密之前的原始数据-&gt;字符串类型</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cipher,<span class="hljs-string">&quot;000&quot;</span>);<br>  <span class="hljs-keyword">return</span> decrypted<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>加密:encrypt(数据,密钥,偏移量)<br>解密:decrypt(数据,密钥,偏移量)</p>
<h3 id="rsa加密解密"><a href="#rsa加密解密" class="headerlink" title="rsa加密解密"></a>rsa加密解密</h3><p>1.npm i wxmp-rsa -S<br>2.import WxmpRsa from ‘wxmp-rsa’<br>3.实例化rsa<br>const rsa &#x3D; new WxmpRsa()<br>4.定义公钥<br>const publicKey &#x3D; <code>  -----BEGIN PUBLIC KEY-----   MIGeMA0GCSqGSIb3DQEBAQUAA4GMADCBiAKBgFnWSUwsmGawhMJ30z6y5li2jcf1   m7rPMZcwZOS3To8bk3OBaMGhVEc1F8GtJBbc1rn/HCLNL9zrCy21EefJON8tRFcY   HnpseZSzh+349lIhS+MFw9x4JUddwSPDyxwha929cKzMuVoftu3CJ+kqDBVvxLk7   iDBzUMqW3Kgehk2TAgMBAAE=   -----END PUBLIC KEY-----</code><br> 5.设置公钥<br>rsa.setPublicKey(publicKey)<br>6.加密<br>const cryptStr &#x3D; rsa.encryptLong(str)<br>console.log(‘加密后的结果：’, cryptStr)<br>7.&#x2F;&#x2F; 定义私钥<br>const privateKey &#x3D; <code>-----BEGIN RSA PRIVATE KEY----- MIICWgIBAAKBgFnWSUwsmGawhMJ30z6y5li2jcf1m7rPMZcwZOS3To8bk3OBaMGh VEc1F8GtJBbc1rn/HCLNL9zrCy21EefJON8tRFcYHnpseZSzh+349lIhS+MFw9x4 JUddwSPDyxwha929cKzMuVoftu3CJ+kqDBVvxLk7iDBzUMqW3Kgehk2TAgMBAAEC gYBRChPeyk/EOrHX912xLpLKLguh+LY9g1B50ScChzUvtTGDPZaxLQYoogVHKhfn I9nzuOS5pBzsDX9tAO0hCQzqfHgqRjn+vEgm1Ui+f0E3BVRnhobcJKZpZqlvCBR5 Gu2+zlrY4SeGq3AuQSr/A5FiB5k0RgsvNycDTjqyg7TXGQJBAJoZ8Yr0zakxT1I8 lVqsFbeNPtt8FNG2UgIlIs9RL7aXhw+Y3sWtk/kbaOXafSofu0NcQYx4Km3M3kiP lcNfTJ8CQQCVPcaRpu+mprRgHS6s76Z668NaFsjX04CUUa0kCrey+Nf/SJJ3BkRH M7GllZWuI/RSXs/F5N38p5bfkn7QZqaNAkBy3dHJZW8DpgjdYOFnhAxwFK39BwGx zHhWtv26kWbCcTKwsp+jtB4vunm3k+RmiN6aeGM35L6jt+kdJ0JYLmo7AkBJpRZb wZj5D8Jqu3vQ8uGgPr9DsYKinkgQ6M0bv/4uXwWXf+Rmv7zpteSv5UTbjfp+uzKk YO/6QWj+InhZto3xAkAOA0i702dLHm5elLWvht7UEYIDEW1+rYGdbthmJBvT9sZh VKL954Y9hDzBWepjYsBiJnmIkgeladPnU5025/G/ -----END RSA PRIVATE KEY-----</code><br>8. 设置私钥<br>rsa.setPrivateKey(privateKey)<br>9. 解密<br>const originalStr &#x3D; rsa.decryptLong(cryptStr)<br>console.log(‘解密后的原始数据：’, originalStr)</p>
<h3 id="WebSocket-是什么？"><a href="#WebSocket-是什么？" class="headerlink" title="WebSocket 是什么？"></a>WebSocket 是什么？</h3><p><a target="_blank" rel="noopener" href="http://websocket.org/">WebSocket</a> 是一种网络通信协议。<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6455">RFC6455</a> 定义了它的通信标准。<br>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。</p>
<h3 id="为什么需要-WebSocket-？"><a href="#为什么需要-WebSocket-？" class="headerlink" title="为什么需要 WebSocket ？"></a>为什么需要 WebSocket ？</h3><p>了解计算机网络协议的人，应该都知道：HTTP 协议是一种无状态的、无连接的、单向的应用层协议。它采用了请求&#x2F;响应模型。通信请求只能由客户端发起，服务端对请求做出应答处理。<br>这种通信模型有一个弊端：HTTP 协议无法实现服务器主动向客户端发起消息。<br>这种单向请求的特点，注定了如果服务器有连续的状态变化，客户端要获知就非常麻烦。大多数 Web 应用程序将通过频繁的异步 JavaScript 和 XML（AJAX）请求实现长轮询。轮询的效率低，非常浪费资源（因为必须不停连接，或者 HTTP 连接始终打开）。</p>
<h3 id="客户端-API"><a href="#客户端-API" class="headerlink" title="客户端 API"></a>客户端 API</h3><p>以下 API 用于创建 WebSocket 对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">var Socket = new WebSocket(url, [protocol] );<br></code></pre></td></tr></table></figure>
<h3 id="WebSocket-的属性"><a href="#WebSocket-的属性" class="headerlink" title="WebSocket 的属性"></a>WebSocket 的属性</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/png/29366328/1667460339404-c3dd71a2-c2db-4d62-b5f0-0d26d76ac994.png#clientId=u734cbe78-c3bb-4&from=paste&height=395&id=u1750581a&name=image.png&originHeight=395&originWidth=1421&originalType=binary&ratio=1&rotation=0&showTitle=false&size=99705&status=done&style=none&taskId=u741ed1b8-42e7-4d6d-b714-18e4c3a9269&title=&width=1421" alt="image.png"></p>
<h3 id="WebSocket-的事件"><a href="#WebSocket-的事件" class="headerlink" title="WebSocket 的事件"></a>WebSocket 的事件</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/png/29366328/1667460379331-f48ff246-e082-469a-b50a-a33ead3b9fff.png#clientId=u734cbe78-c3bb-4&from=paste&height=384&id=u6a0a53fe&name=image.png&originHeight=384&originWidth=1431&originalType=binary&ratio=1&rotation=0&showTitle=false&size=60285&status=done&style=none&taskId=uf969632d-02d8-434c-ab31-b0c4cd30db7&title=&width=1431" alt="image.png"></p>
<h3 id="WebSocket-的方法"><a href="#WebSocket-的方法" class="headerlink" title="WebSocket 的方法"></a>WebSocket 的方法</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/png/29366328/1667460423633-62329e4d-d274-4ce1-80f0-f31b98f27c17.png#clientId=u734cbe78-c3bb-4&from=paste&height=236&id=u3dbde3e6&name=image.png&originHeight=236&originWidth=1418&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25435&status=done&style=none&taskId=u55d6e3df-856e-49f6-819f-cdfe805e1e0&title=&width=1418" alt="image.png"></p>
<h3 id="WebSocket-连接demo"><a href="#WebSocket-连接demo" class="headerlink" title="WebSocket 连接demo"></a>WebSocket 连接demo</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 初始化一个 WebSocket 对象</span><br><span class="hljs-keyword">var</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">&#x27;ws://localhost:9998/echo&#x27;</span>);<br><br><span class="hljs-comment">// 建立 web socket 连接成功触发事件</span><br>ws.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// 使用 send() 方法发送数据</span><br>  ws.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;发送数据&#x27;</span>);<br>  <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;数据发送中...&#x27;</span>);<br>&#125;;<br><br><span class="hljs-comment">// 接收服务端数据时触发事件</span><br>ws.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) &#123;<br>  <span class="hljs-keyword">var</span> received_msg = evt.<span class="hljs-property">data</span>;<br>  <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;数据已接收...&#x27;</span>);<br>&#125;;<br><br><span class="hljs-comment">// 断开 web socket 连接成功触发事件</span><br>ws.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;连接已关闭...&#x27;</span>);<br>&#125;;<br><br></code></pre></td></tr></table></figure>
<h3 id="兼职聊天页面WebSocket-连接步骤"><a href="#兼职聊天页面WebSocket-连接步骤" class="headerlink" title="兼职聊天页面WebSocket 连接步骤"></a>兼职聊天页面WebSocket 连接步骤</h3><p>1.全局定义websocket对象<br><img src="https://cdn.nlark.com/yuque/0/2022/png/29366328/1667461811933-5eff9301-1951-4204-85d7-aab306fa67d6.png#clientId=u734cbe78-c3bb-4&from=paste&height=28&id=ub21b3cbf&name=image.png&originHeight=28&originWidth=413&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1724&status=done&style=none&taskId=u2996a451-819b-4d95-a3a2-97262402784&title=&width=413" alt="image.png"><br>2.建立webscoket连接</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript">socketTaskRoom = wx.<span class="hljs-title function_">connectSocket</span>(&#123;<br>  <span class="hljs-attr">url</span>: <span class="hljs-string">`wss://mall.wuhanzhuangxiu01.cn/job_ws/chat/<span class="hljs-subst">$&#123;that.$store.state.openid&#125;</span>__<span class="hljs-subst">$&#123;that.jobDetailObj.openid&#125;</span>/?_=<span class="hljs-subst">$&#123;time&#125;</span>&amp;dds=<span class="hljs-subst">$&#123;postData&#125;</span>&amp;rk=<span class="hljs-subst">$&#123;that.key&#125;</span>`</span>,<br>  <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>连接url动态生成，当前用户openid___被连接用户openid + 时间戳 +dds + rk<br>dds &#x3D; postdata; rk &#x3D; key<br>key &#x3D; rsa加密（时间戳+三位随机字符串）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript">urlData = <span class="hljs-string">`user_id=<span class="hljs-subst">$&#123;that.$store.state.openid&#125;</span>&amp;username=<span class="hljs-subst">$&#123;that.$store.state.user_name&#125;</span>&amp;chat_with_id=<span class="hljs-subst">$&#123;that.jobDetailObj.openid&#125;</span>&amp;chat_with_name=<span class="hljs-subst">$&#123;that.jobDetailObj.username&#125;</span>&amp;chat_job_id=<span class="hljs-subst">$&#123;that.jobDetailObj.id&#125;</span>&amp;chat_job_title=<span class="hljs-subst">$&#123;that.jobDetailObj.title&#125;</span>&amp;appid=<span class="hljs-subst">$&#123;that.$store.state.appid&#125;</span>&amp;avatar=<span class="hljs-subst">$&#123;that.$store.state.user_img&#125;</span>&amp;chat_with_avatar=<span class="hljs-subst">$&#123;that.jobDetailObj.headimg&#125;</span>`</span><br>postData = <span class="hljs-title function_">encrypt</span>(urlData,time+randomStr,<span class="hljs-variable language_">this</span>.<span class="hljs-property">iv</span>)<br></code></pre></td></tr></table></figure>
<p>iv &#x3D; MD5加密（时间戳）.substr(8,16)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript">socketTaskRoom.<span class="hljs-title function_">onOpen</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) &#123;<br>					  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;WebSocket连接已打开！&#x27;</span>);<br>					  socketOpen = <span class="hljs-literal">true</span><br>					&#125;);<br>					socketTaskRoom.<span class="hljs-title function_">onError</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) &#123;<br>					  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;WebSocket连接打开失败，请检查！&#x27;</span>);<br>					  socketOpen = <span class="hljs-literal">false</span><br>					&#125;);<br>					socketTaskRoom.<span class="hljs-title function_">onMessage</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) &#123;<br>						<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;收到服务器内容：&#x27;</span> + res.<span class="hljs-property">data</span>);<br>						that.<span class="hljs-title function_">getSocketMsg</span>(res.<span class="hljs-property">data</span>); <span class="hljs-comment">// 监听到有新服务器消息</span><br>						that.<span class="hljs-property">talkList</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(res.<span class="hljs-property">data</span>))<br>					<br>					&#125;)<br>					socketTaskRoom.<span class="hljs-title function_">onClose</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) &#123;<br>					  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;WebSocket 已关闭！&#x27;</span>);<br>					&#125;);<br></code></pre></td></tr></table></figure>
<p>所有数据处理完成后，连接成功，通过onopen方法监听到连接成功消息，<br>通过onMessage收到服务端推送的消息，拿到消息后json parse push进聊天列表（此时消息都是新的聊天内容）<br>本地通过send方法发送消息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> obj = &#123;<span class="hljs-attr">send_user_id</span>: that.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">openid</span>, <span class="hljs-attr">send_username</span>: that.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">user_name</span>, <span class="hljs-attr">send_time</span>: <span class="hljs-string">&quot;2022-10-13 11:40:00&quot;</span>, <span class="hljs-attr">send_message</span>: <span class="hljs-string">&quot;我是user1&quot;</span>, <span class="hljs-attr">chat_with_id</span>: that.<span class="hljs-property">oid</span>, <span class="hljs-attr">chat_with_name</span>: that.<span class="hljs-property">jobDetailObj</span>.<span class="hljs-property">username</span>,<span class="hljs-attr">chat_job_id</span>:that.<span class="hljs-property">jobDetailObj</span>.<span class="hljs-property">id</span>,<span class="hljs-attr">chat_job_title</span>:that.<span class="hljs-property">jobDetailObj</span>.<span class="hljs-property">title</span>,<span class="hljs-attr">appid</span>:that.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">appid</span>,<span class="hljs-attr">avatar</span>:that.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">user_img</span>,<span class="hljs-attr">chat_with_avatar</span>:that.<span class="hljs-property">jobDetailObj</span>.<span class="hljs-property">headimg</span>&#125;<br>socketTaskRoom.<span class="hljs-title function_">send</span>(&#123;<br>						<span class="hljs-attr">data</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj),<br>						<span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>							<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);<br>						&#125;<br>					&#125;);<br></code></pre></td></tr></table></figure>
<p>消息发送成功后，onMessage可以监听到服务端返回的消息列表，即你此时发送成功的消息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 发送信息</span><br>			<span class="hljs-title function_">send</span>(<span class="hljs-params"></span>)&#123;<br>				<span class="hljs-keyword">if</span>(!<span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>)&#123;<br>					uni.<span class="hljs-title function_">showToast</span>(&#123;<br>						<span class="hljs-attr">title</span>:<span class="hljs-string">&#x27;请输入有效的内容&#x27;</span>,<br>						<span class="hljs-attr">icon</span>:<span class="hljs-string">&#x27;none&#x27;</span><br>					&#125;)<br>					<span class="hljs-keyword">return</span>;<br>				&#125;<br>				uni.<span class="hljs-title function_">showLoading</span>(&#123;<br>					<span class="hljs-attr">title</span>:<span class="hljs-string">&#x27;正在发送&#x27;</span><br>				&#125;)<br>				<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>					uni.<span class="hljs-title function_">hideLoading</span>();<br>					<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendMessage</span>()<br>					<span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-comment">// 清空内容框中的内容</span><br>						<span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>						uni.<span class="hljs-title function_">pageScrollTo</span>(&#123;<br>						    <span class="hljs-attr">scrollTop</span>: <span class="hljs-number">999999</span>,	<span class="hljs-comment">// 设置一个超大值，以保证滚动条滚动到底部</span><br>						    <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span><br>						&#125;);<br>					&#125;)<br>				&#125;,<span class="hljs-number">500</span>);<br>			&#125;,<br></code></pre></td></tr></table></figure>
<h3 id="聊天历史记录获取"><a href="#聊天历史记录获取" class="headerlink" title="聊天历史记录获取"></a>聊天历史记录获取</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">getHistory</span>(<span class="hljs-params"></span>)&#123;<br>				<span class="hljs-keyword">let</span> that = <span class="hljs-variable language_">this</span><br>				<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(that.<span class="hljs-property">jobDetailObj</span>,<span class="hljs-string">&quot;1111111&quot;</span>);<br>				uni.<span class="hljs-title function_">request</span>(&#123;<br>					<span class="hljs-attr">url</span>:<span class="hljs-string">`https://mall.wuhanzhuangxiu01.cn/job_chat/ch`</span>,<br>					<span class="hljs-attr">data</span>:&#123;<br>						<span class="hljs-string">&quot;user_id&quot;</span>:that.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">openid</span>,<br>						<span class="hljs-string">&quot;chat_with_id&quot;</span>:that.<span class="hljs-property">type</span>==<span class="hljs-number">2</span>?that.<span class="hljs-property">oid</span>:that.<span class="hljs-property">jobDetailObj</span>.<span class="hljs-property">openid</span>,<br>						<span class="hljs-string">&quot;appid&quot;</span>:that.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">appid</span><br>					&#125;,<br>					<span class="hljs-attr">method</span>:<span class="hljs-string">&quot;POST&quot;</span>,<br>					<span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>						<span class="hljs-keyword">let</span> jsonData = <span class="hljs-title function_">decrypt</span>(res.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>,<span class="hljs-string">&quot;2031618372682131&quot;</span>,<span class="hljs-string">&quot;9329859705602774&quot;</span>)<br>						<span class="hljs-comment">// console.log(res.data.data);</span><br>						<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(jsonData,<span class="hljs-string">&quot;解密后&quot;</span>);<br>						that.<span class="hljs-title function_">hideLoadTips</span>(<span class="hljs-literal">true</span>);<br>						that.<span class="hljs-property">talkList</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(jsonData)<br>						<br>					&#125;<br>				&#125;)<br>			&#125;,<br></code></pre></td></tr></table></figure>
<h3 id="聊天列表界面websocket"><a href="#聊天列表界面websocket" class="headerlink" title="聊天列表界面websocket"></a>聊天列表界面websocket</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">getChatList</span>(<span class="hljs-params"></span>)&#123;<br>				<span class="hljs-keyword">let</span> that = <span class="hljs-variable language_">this</span><br>				socketTaskList = wx.<span class="hljs-title function_">connectSocket</span>(&#123;<br>				  <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;wss://mall.wuhanzhuangxiu01.cn/job_ws/chatList/&#x27;</span><br>				&#125;);<br>				socketTaskList.<span class="hljs-title function_">onOpen</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) &#123;<br>				  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;WebSocket连接已打开！&#x27;</span>);<br>				  that.<span class="hljs-title function_">btn</span>()<br>				  socketOpen = <span class="hljs-literal">true</span><br>				&#125;);<br>				socketTaskList.<span class="hljs-title function_">onError</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) &#123;<br>				  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;WebSocket连接打开失败，请检查！&#x27;</span>);<br>				  socketOpen = <span class="hljs-literal">false</span><br>				&#125;);<br>				socketTaskList.<span class="hljs-title function_">onMessage</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) &#123;<br>					<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;收到服务器内容：&#x27;</span> + res.<span class="hljs-property">data</span>);<br>					<span class="hljs-keyword">let</span> data = <span class="hljs-title function_">decrypt</span>(res.<span class="hljs-property">data</span>,<span class="hljs-string">&#x27;1189789282863375&#x27;</span>,<span class="hljs-string">&#x27;5671714989170848&#x27;</span>)<br>					<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data));<br>					that.<span class="hljs-property">list</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data)<br>				<br>				&#125;)<br>				socketTaskList.<span class="hljs-title function_">onClose</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) &#123;<br>				  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;WebSocket 已关闭！&#x27;</span>);<br>				&#125;);<br>			&#125;,<br></code></pre></td></tr></table></figure>
<p>页面跳转时断开连接<br>socketTaskList.close()</p>
<h3 id="websocket重连机制"><a href="#websocket重连机制" class="headerlink" title="websocket重连机制"></a>websocket重连机制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">checkOpenSocket</span>(<span class="hljs-params"></span>) &#123;<br>				socketTaskRoom.<span class="hljs-title function_">send</span>(&#123;<br>					<span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;ping&#x27;</span>,<br>					<span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>						<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);<br>						<span class="hljs-keyword">return</span>;<br>					&#125;,<br>					<span class="hljs-attr">fail</span>: <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>						<span class="hljs-comment">// 未连接打开websocket连接</span><br>						<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">lianJie</span>()<br>					&#125;<br>				&#125;);<br>			&#125;,<br><span class="hljs-comment">// 检测心跳reset  在监听到服务端消息时调用</span><br>			<span class="hljs-title function_">reset</span>(<span class="hljs-params"></span>) &#123;    <br>				<span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeoutObj</span>);<br>				<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// 启动心跳</span><br>			&#125;,<br>			<span class="hljs-comment">// 启动心跳 start</span><br>			<span class="hljs-title function_">start</span>(<span class="hljs-params"></span>) &#123;<br>				<span class="hljs-keyword">let</span> that = <span class="hljs-variable language_">this</span><br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeoutObj</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>					socketTaskRoom.<span class="hljs-title function_">send</span>(&#123;<br>						<span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;ping&#x27;</span>,<br>						<span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>							<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);<br>							<br>						&#125;,<br>						<span class="hljs-attr">fail</span>: <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>							<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;连接失败重新连接....&#x27;</span>);<br>							<span class="hljs-comment">// that.addKey();</span><br>						&#125;<br>					&#125;);<br>				&#125;, <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);<br>			&#125;,<br></code></pre></td></tr></table></figure>

<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2022/12/02/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">← Next 数据结构与算法</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2022/09/25/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E8%AF%A6%E8%A7%A3/">微信支付详解 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="文章目录">≡</a><a id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Salty Sun</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#AES%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86"><span class="toc-number">1.</span> <span class="toc-text">AES加密解密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rsa%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86"><span class="toc-number">2.</span> <span class="toc-text">rsa加密解密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSocket-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">3.</span> <span class="toc-text">WebSocket 是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-WebSocket-%EF%BC%9F"><span class="toc-number">4.</span> <span class="toc-text">为什么需要 WebSocket ？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-API"><span class="toc-number">5.</span> <span class="toc-text">客户端 API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSocket-%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">6.</span> <span class="toc-text">WebSocket 的属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSocket-%E7%9A%84%E4%BA%8B%E4%BB%B6"><span class="toc-number">7.</span> <span class="toc-text">WebSocket 的事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSocket-%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">8.</span> <span class="toc-text">WebSocket 的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSocket-%E8%BF%9E%E6%8E%A5demo"><span class="toc-number">9.</span> <span class="toc-text">WebSocket 连接demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%BC%E8%81%8C%E8%81%8A%E5%A4%A9%E9%A1%B5%E9%9D%A2WebSocket-%E8%BF%9E%E6%8E%A5%E6%AD%A5%E9%AA%A4"><span class="toc-number">10.</span> <span class="toc-text">兼职聊天页面WebSocket 连接步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%8A%E5%A4%A9%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E8%8E%B7%E5%8F%96"><span class="toc-number">11.</span> <span class="toc-text">聊天历史记录获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%8A%E5%A4%A9%E5%88%97%E8%A1%A8%E7%95%8C%E9%9D%A2websocket"><span class="toc-number">12.</span> <span class="toc-text">聊天列表界面websocket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#websocket%E9%87%8D%E8%BF%9E%E6%9C%BA%E5%88%B6"><span class="toc-number">13.</span> <span class="toc-text">websocket重连机制</span></a></li></ol></div></div><footer><nobr>使用 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>博士 <a target="_blank" rel="noopener" href="https://github.com/SaltySun">SaltySun</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{code.findCode();}</script><script src="/js/arknights.js"></script><script src="/js/pjax.js"></script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>